---
title: "Analysis"
author: "ABB"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)

# green is the reconciled one
# (NOT to be answered by REVIEWER) Has the study been reconciled?_cb623db2-5f5e-4676-9497-f22d4d58fd02 == YES is reconciled

#read in document
library(openxlsx)
#data <- openxlsx::read.xlsx("0531_final_data_after_cleaning.xlsx", fillMergedCells = TRUE, colNames = FALSE)

#data <- openxlsx::read.xlsx("0531_final_data_after_cleaning0628.xlsx", fillMergedCells = TRUE, colNames = FALSE)

# data <- openxlsx::read.xlsx("final_data_after_cleaning0717.xlsx", fillMergedCells = TRUE, colNames = FALSE)


data <- openxlsx::read.xlsx("final_data_after_cleaning0726.xlsx", fillMergedCells = TRUE, colNames = FALSE)

names(data) <- paste(data[1, ], data[2, ], sep = "_")
names(data)[1] <- "study_ID"
# Get rid of first two rows and columns 
data <- data[-c(1:2), ]

# clean column names
library(janitor)

clean_names(data)
# remove brackets so can search by numbers
colnames(data) <-  gsub("\\(|)","",colnames(data))


# library(tidyverse)
## get only reconciled
reconciled <- data %>% subset(data$`NOT to be answered by REVIEWER Has the study been reconciled?_cb623db2-5f5e-4676-9497-f22d4d58fd02_Answer` == "Yes") 

# check the number of reconciled studies and confirm with project lead 
nrow(reconciled)
# 63
length(unique(reconciled$study_ID))
# 63 unique studies

# make all columns factors
cols <- colnames(reconciled[,21:170])
reconciled[cols] <- lapply(reconciled[cols], factor)

```

## Plan of analysis to be carried out

<!-- https://lucid.app/lucidchart/07544fa2-2781-40f0-b03b-d3d3595d9443/edit?viewport_loc=-325%2C-1822%2C3711%2C2979%2C0_0&invitationId=inv_b89952a6-b78e-49f7-9d45-e64aa7af5638  -->

for simple diagrams, 

for complex connections - sankey diagram - for the link between printing methods + printing model with a link to the bioink type (+ origin)?

first things first, to give numbers of studies that report e.g. A or B

# Printing Techniques 

Give an overview of the different printing techniques, 
- method
- printer model
- printer source
- forms 
- software 


## Kind of Printer Method
```{r printing-method, echo = TRUE}
t1 <- table(reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`)
##
        # Extrusion based Extrusion based|Unclear            Inject based 
        #              37                       1                       4 
        #           Other       Stereolithography                 Unclear 
        #               9                       2                      10

# proportions instead of absolute value of number of studies 
prop.table(table(reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`))

 # barplot(t1, ylab = "Number of studies", ylim=c(0, max(t1) + 20),cex.names=.5 , col = "green")


print_method <- reconciled %>%  
                  select(study_ID, 
                   `4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`, 
                  `4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Comments` ) %>% 
                  separate_rows(`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`, sep="\\|") 

t1 <- table(print_method$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`)



text(x = barplot(t1, ylab = "Number of studies", ylim=c(0, max(t1) + 10), cex.names=0.8, col = "green", main = "Kind of printing method used", las=0), y = t1 + 2, labels = t1, cex = 0.8 )


### ABB add table to specfiy other 

# remove line breaks
library(stringr)

print_method_comment_other <- tibble( 
                  study_ID = reconciled$study_ID, 
                 method =  reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`, 
                 comment = reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Comments` ) 

print_method_comment_other <- print_method_comment_other %>% 
                  separate_rows(method, sep="\\|") %>%  
  subset(method == "Other")


print_method_comment_other$comment <- str_replace_all(print_method_comment_other$comment, "[\n]" , "")

# remove whitespace from start of str
print_method_comment_other$comment <- str_trim(print_method_comment_other$comment, "left")

# remove whitespace from end of str
print_method_comment_other$comment <- str_trim(print_method_comment_other$comment, "right")

# liverType <- separate_rows(liverType, liverCellsComment, sep=";")

print_method_comment_other$comment <- as.factor(print_method_comment_other$comment)

table(print_method_comment_other$comment)

print_method_comment_other <- print_method_comment_other %>% 
      mutate(comment = recode(comment, "micro array spotter" = "microarray spotter")) %>% mutate(comment = recode(comment, "scaffold free bioprinting" = "scaffold-free bioprinting"))

# -- link printing method with bioInk type - 

# group by numbers
commentsPrintMethod <- print_method_comment_other %>%  group_by(comment) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(commentsPrintMethod,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("green")
))

```


## Reporting of Printer Model 
```{r printer-model}

#### Reporting of Printer Model

t2 <- table(reconciled$`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`)
         # Not reported Not reported|Reported              Reported 
         #           22                     1                    4


# barplot(table(reconciled$`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`), ylab = "Number of studies")

print_model <- reconciled %>%  
                  select(study_ID, 
                   `4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`) %>% 
                  separate_rows(`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`, sep="\\|")

t2 <- table(print_model$`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`)





text(x = barplot(t2, ylab = "Number of studies", ylim=c(0, max(t2) + 10), cex.names=0.8, col = "green", main = "Is printer model name/number reported"), y = t2 + 2, labels = t2, cex = 0.8)

```


## Printer Source 
```{r printer-source}

#### Reporting of Printer Source

t3 <- table(reconciled$`4.1.2 What is the source of the printer?_102ba965-5234-4b3e-8b23-bd70cf4e074d_Answer`)
         # commercial modified commercial        not reported 
         #         36                   4                   4 
         #  self-made             unclear  unclear|commercial 
         #         13                   5                   1

# barplot(table(reconciled$`4.1.2 What is the source of the printer?_102ba965-5234-4b3e-8b23-bd70cf4e074d_Answer`), ylab = "Number of studies", cex.names=.5,  col = "green")

text(x = barplot(t3, ylab = "Number of studies", ylim=c(0, max(t3) + 10), cex.names=.8 , col = "green", main = "Source of the printer"), y = t3 + 2, labels = t3, cex = 0.8)

```


## Printer Forms 
```{r printer-forms}

#### Reporting of Printer forms
# split is based on the ink

table(reconciled$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`)
        #                Grid                  Grid;Other 
        #                  19                           1 
        #           Grid|Grid               lobular liver 
        #                   2                           7 
        # lobular liver;Other lobular liver|lobular liver 
        #                   1                           2 
        #               Other                 Other|Other 
        #                  25                           5 
        #             Toroids 
        #                   1

# ABB to clean these responses
# Those with a semicolon response ; should now be called "combo"
# responses separate with a pipe should be merged when they are saying the same thing. 

printer_forms <- reconciled %>% 
  mutate(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`= recode(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, "Grid|Grid" = "Grid")) %>% 
  mutate(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`= recode(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, "lobular liver|lobular liver" = "lobular liver")) %>% 
  mutate(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`= recode(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, "Other|Other" = "Other")) %>% 
  mutate(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`= recode(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, "Grid;Other" = "Combination")) %>% 
  mutate(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`= recode(`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, "lobular liver;Other" = "Combination"))

t4 <-table(printer_forms$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`)


# barplot(table(printer_forms$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`), ylab = "Number of studies", cex.names=.5 , col = "green")

text(x = barplot(t4, ylab = "Number of studies", ylim=c(0, max(t4) + 10), cex.names=.8 , col = "green", main = "What kind of forms are printed with this ink"), y = t4 + 2, labels = t4, cex = 0.8)

```




### Figure 1d - What "Other" printed forms are used? 
```{r printer-forms-other, warning=FALSE}

library(stringr)

print_method_comment_other <- tibble( 
   study_ID = reconciled$study_ID, 
   method =  reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`, 
   comment = reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Comments` ) 

print_method_comment_other <- print_method_comment_other %>% 
                  separate_rows(method, sep="\\|") %>%  
                  subset(method == "Other")

# remove line breaks
print_method_comment_other$comment <- str_replace_all(print_method_comment_other$comment, "[\n]" , "")

# remove whitespace from start of str
print_method_comment_other$comment <- str_trim(print_method_comment_other$comment, "left")

# remove whitespace from end of str
print_method_comment_other$comment <- str_trim(print_method_comment_other$comment, "right")

# turn variable into a factor to group similar
print_method_comment_other$comment <- as.factor(print_method_comment_other$comment)

# table(print_method_comment_other$comment)

# rename answers to more easily group them
print_method_comment_other <- print_method_comment_other %>% 
      mutate(comment = recode(comment, "micro array spotter" = "microarray spotter")) %>% mutate(comment = recode(comment, "scaffold free bioprinting" = "scaffold-free bioprinting"))

# group by numbers
commentsPrintMethod <- print_method_comment_other %>%  group_by(comment) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(commentsPrintMethod,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("green")
))


```

### Figure 1d - What "Other" printed forms are used? 
```{r printer-forms-other, warning=FALSE}

library(stringr)

print_form_comment_other <- tibble( 
   study_ID = reconciled$study_ID, 
   method =  reconciled$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, 
   comment = reconciled$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Comments`) 

print_form_comment_other <- print_form_comment_other %>% 
                  separate_rows(method, sep="\\|") %>%  
                  subset(method == "Other")

print_form_comment_other <- print_form_comment_other %>% 
                  separate_rows(comment, sep="\\|")

# remove line breaks
print_form_comment_other$comment <- str_replace_all(print_form_comment_other$comment, "[\n]" , "")

# remove whitespace from start of str
print_form_comment_other$comment <- str_trim(print_form_comment_other$comment, "left")

# remove whitespace from end of str
print_form_comment_other$comment <- str_trim(print_form_comment_other$comment, "right")

# turn variable into a factor to group similar
#print_form_comment_other$comment <- as.factor(print_form_comment_other$comment)

 table(print_form_comment_other$comment)

# is.data.frame(print_form_comment_other)
 
# rename answers to more easily group them
print_form_comment_other <- print_form_comment_other %>% 
      mutate(comment = recode(comment, "doplets" = "droplets")) %>% 
      mutate(comment = recode(comment, "printing on a chip" = "printed on a chip")) %>%   
     mutate(comment = recode(comment, "spheroid" = "spheroids")) %>%
     mutate(comment = recode(comment, "hexagonal constructs" = "hexagonal"))
             

# group by numbers
commentsPrintForm <- print_form_comment_other %>%  group_by(comment) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(commentsPrintForm,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("green")
))


```


### Printer Forms Overtime 
```{r printer-forms-time}


printer_form_year<- table(printer_forms$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`, printer_forms$NA_Year)


printer_form_yearDF <- as.data.frame(printer_form_year)
# long to wide 
printer_form_yearDF <- printer_form_yearDF %>% spread(
   key = Var2, 
   value = Freq)


# printer_form_yearDF 
# names(printer_form_yearDF) <- gsub(x = names(printer_form_yearDF), pattern = "X", replacement = "")  


library(formattable)

formattable(printer_form_yearDF,
            #align =c("l", "r"),
            list(
              `Indicator Name` = formatter(
              "span", 
              style = ~ style(color = "grey",font.weight = "bold")), 
             area(row = 1:5) ~ color_tile("white", "green")))



```





## Printer Software 
```{r printer-software}

#### Reporting of Printer software

table(reconciled$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`)
            # No          No|No Not applicable            Yes 
            # 39              1              1             22

## ABB combine No|No into the "No" group 
printer_soft <- reconciled %>% 
  mutate(`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer` = recode(`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`, "No|No" = "No") )

t5 <- table(printer_soft$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`)

# barplot(table(printer_soft$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`), ylab = "Number of studies", cex.names=.5, col = "green")

text(x = barplot(t5, ylab = "Number of studies", ylim=c(0, max(t5) + 10), cex.names=.8 , col = "green", main = "Is the 3D modelling software reported"), y = t5 + 2, labels = t5, cex = 0.8)

## Slicing Software

# - since the review started, many cases - not applicable 
# merge NA with No and merge No|No with NO
table(reconciled$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`)
            # No          No|No Not applicable            Yes 
            # 53              1              1              8 

## ABB to clean No|No and Not applicable into the No option. 

printer_slice <- printer_soft %>% 
  mutate(`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer` = recode(`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`, "No|No" = "No")) %>% 
   mutate(`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer` = recode(`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`, "Not applicable" = "No"))

t6 <- table(printer_slice$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`)


# t6_6 <- table(printer_slice$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`, printer_slice$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`)
# t6_6
# barplot(table(printer_slice$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`), ylab = "Number of studies", cex.names=.5, col = "green")

text(x = barplot(t6, ylab = "Number of studies", ylim=c(0, max(t6) + 10), cex.names=.8 , col = "green", main = "Is the name of the slicing software reported?"), y = t6 + 2, labels = t6, cex = 0.8, )




#####
# stacked barplot to combine software & slice software

# library(ggplot2)
# 
# software <- printer_slice %>% 
#                       group_by(`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`, printer_slice$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`) %>% count()
# 
# colnames(software) <- c("threeD-software", "slice-software", "number-studies")
# 
# #, printer_slice$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`))
# 
# ggplot(software, aes(fill=`slice-software`, y=`number-studies`, x=`threeD-software`)) + 
#   geom_bar(position='stack', stat='identity')

#software$`number-studies`


############


```



# BioInks

Give an overview of the different inks used with these techniques. 
- type
- origin
- additives
- density

ABB link bioink to printing method

```{r printing-inks, echo=TRUE}
## Type of BioInk
t7 <- table(reconciled$`4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`)
# clean? 

        #      Natural      Natural|Natural    Natural|Synthetic 
        #           43                    3                    5 
        # Not reported Not reported|Natural            Synthetic 
        #            2                    1                    4 
        #      Unclear 
        #            5 

# barplot(t7, ylab = "Number of studies", cex.names=.5, col = "blue")

text(x = barplot(t7, ylab = "Number of studies", ylim=c(0, max(t7) + 10), cex.names=.5 , col = "blue", main = "What type of BioInk is used"), y = t7 + 2, labels = t7, cex = 0.8, )

## If natural - what is the type type
table(reconciled$`4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`)
# output needs cleaning 


table(reconciled$`4.1.3.1.4Â If Synthetic bioink: choose the type _e74ea0e0-a654-4ae2-b59e-2e0b14a4651a_Answer`)


## 3rd level 
table(reconciled$`4.1.3.1.2Â If Protein based: choose the type._621671b3-9f7e-4a22-80ac-14b02fdd0683_Answer`)

table(reconciled$`4.1.3.1.3 If Polysaccharides Based: choose the type. _fcea8bcb-da6c-4154-aa44-8ff4734fa4fe_Answer`) 


##################################### ORIGIN ###################################################
## Origin of BioInk 
t8 <- table(reconciled$`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`)
# needs cleaning

#           commercial (ready-to-use)                   custom formulated 
#                                   6                                  44 
# custom formulated|custom formulated                        Not reported 
#                                   8                                   2 
#                             Unclear                     Unclear|Unclear 
#                                   2                                   1 


bioOrigin <-  reconciled %>%select(
  study_ID, 
    `4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`, 
  `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`
  ) 


bioOrigin_1 <- separate_rows(bioOrigin, `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer` , sep="\\|")
bioOrigin_2 <- separate_rows(bioOrigin_1, `4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`, sep="\\|")


bioOrigin_4 <- bioOrigin %>%  
                separate_rows(`4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, sep="\\|") %>% 
                separate_rows(`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`, sep="\\|") 
  
# something is not working correctly - the distinct is removing the ones where they have both two options in 
bioOrigin_3 <- bioOrigin_2 %>% distinct(study_ID, 
                `4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`, 
                `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`
               # ,.keep_all = TRUE
                )


# barplot(table(reconciled$`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`), ylab = "Number of studies", cex.names=.5, col = "blue")

text(x = barplot(t8, ylab = "Number of studies", ylim=c(0, max(t8) + 10), cex.names=.5 , col = "blue", main = "What is the origin of BioInk"), y = t8 + 2, labels = t8, cex = 0.8)



### bioInk type (4.1.3) --> linked to origin of bioink  (4.1.3.2)
reconciled$`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`

## sankey 

#### prep data for sankey diagram
# type --> 
Print_bioinkOrigin <- reconciled %>%select(
  study_ID, 
  `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
 `4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`
)  


Print_bioinkOrigin <- Print_bioinkOrigin  %>% rename(
   typeGeneral_level1 = `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
bioink_origin = `4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`
)



Print_bioinkOrigin1 <- Print_bioinkOrigin %>% 
                separate_rows(bioink_origin , sep="\\|") %>% 
              separate_rows(typeGeneral_level1, sep="\\|") 

Print_bioinkOrigin1$bioink_origin <- as.factor(Print_bioinkOrigin1$bioink_origin)
Print_bioinkOrigin1$typeGeneral_level1 <- as.factor(Print_bioinkOrigin1$typeGeneral_level1 )
  
summary(Print_bioinkOrigin1)

Print_bioinkOrigin1_sankey <- Print_bioinkOrigin1 %>% select(study_ID, bioink_origin, typeGeneral_level1)


# create a table of frequencies
freq_table <- Print_bioinkOrigin1_sankey %>% group_by(bioink_origin, typeGeneral_level1) %>% 
  summarise(n = n())



print(freq_table)

# create a nodes data frame
nodes <- data.frame(name = unique(c(as.character(freq_table$bioink_origin),
                                    as.character(freq_table$typeGeneral_level1))))


# create links dataframe
links <- data.frame(source = match(freq_table$bioink_origin, nodes$name) - 1,
                    target = match(freq_table$typeGeneral_level1, nodes$name) - 1,
                    value = freq_table$n,
                    stringsAsFactors = FALSE)



###############################
library(plotly)

# Make Sankey diagram
plot_ly(
  type = "sankey",
  orientation = "h",
  node = list(pad = 15,
              thickness = 20,
              line = list(color = "black", width = 0.5),
              label = nodes$name),
  link = list(source = links$source,
              target = links$target,
              value = links$value),
  textfont = list(size = 10),
  width = 720,
  height = 380
) %>% layout(title = "Sankey Diagram: BioInk Type & BioInk Origin",
         font = list(size = 14),
         margin = list(t = 40, l = 10, r = 10, b = 10))







```

### BioInk  Additives
```{r}
### Additives
# -- needs cleaning 
table(reconciled$`4.1.3.3Â Which information is provided on the additives in the ink or culture?Â _4c2b5908-9c3c-4ba8-91f2-dd9771ac2ad4_Answer`)
# needs cleaning

liverAdditive <- tibble(
  study_ID = reconciled$study_ID, 
  additive = reconciled$`4.1.3.3Â Which information is provided on the additives in the ink or culture?Â _4c2b5908-9c3c-4ba8-91f2-dd9771ac2ad4_Answer`
)


liverAdditive <- separate_rows(liverAdditive, additive, sep="\\|")
liverAdditive <- separate_rows(liverAdditive, additive, sep=";")

# group by numbers
liverAdditive_count <- liverAdditive %>%  group_by(additive) %>% summarise(n_studies_report = length(unique(study_ID))) %>%  arrange(desc(n_studies_report))

library(formattable)

formattable(liverAdditive_count,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_studies_report`= color_bar("turquoise")
))


#################################
####### How many items were reported? 

additives_studies <- liverAdditive %>%  group_by(study_ID) %>% summarise(n_items_reported = length(unique(additive))) %>%  arrange(desc(n_items_reported)) 

# hist(custom_bioInk_studies$n_items_reported)

t12 <- table(additives_studies$n_items_reported)

#barplot(table(custom_bioInk_studies$n_items_reported), ylab = "Number of studies", cex.names=.7, col = "lightblue")

text(x = barplot(t12, ylab = "Number of studies", ylim=c(0, max(t12) + 10), cex.names=.8 , col = "turquoise", main = "How many items were reported about bioink or co-culture additives?"), y = t12 + 2, labels = t12, cex = 0.8)



###################################################
## 2.1.1.1

additives <- tibble(
  study_ID = reconciled$study_ID, 
  additive = reconciled$`2.1.1.1 If not xeno-free, which additives are included in the study?_39f4070b-a7cd-4b06-9618-47e07363219c_Answer`
)

additives <- separate_rows(additives, additive, sep="\\|")
additives <- separate_rows(additives, additive, sep=";")


# group by numbers
Additive_count <- additives %>%  group_by(additive) %>% summarise(n_studies_report = length(unique(study_ID))) %>%  arrange(desc(n_studies_report))

library(formattable)

formattable(Additive_count,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_studies_report`= color_bar("turquoise")
))


```



### BioInk Cell Density
```{r}

## Cell density of bioInk
table(reconciled$`4.1.3.4 Is the cell density of the bioinkÂ provided in the study?Â _d03a497a-c8ab-49a6-8fa7-5eca0d168c94_Answer`)
# needs cleaning 

     # No   No|No  No|Yes     Yes  Yes|No Yes|Yes 
     # 11       1       1      43       1       6 



cellDensity_report <-  reconciled %>%select(
  study_ID, 
    `4.1.3.4 Is the cell density of the bioinkÂ provided in the study?Â _d03a497a-c8ab-49a6-8fa7-5eca0d168c94_Answer`
  ) 

cellDensity_report <- separate_rows(cellDensity_report, `4.1.3.4 Is the cell density of the bioinkÂ provided in the study?Â _d03a497a-c8ab-49a6-8fa7-5eca0d168c94_Answer`, sep="\\|")

table(cellDensity_report$`4.1.3.4 Is the cell density of the bioinkÂ provided in the study?Â _d03a497a-c8ab-49a6-8fa7-5eca0d168c94_Answer`)

#################### CELL DENSITY ACTUAL 

cellDensity_num <- tibble(
  study_ID = reconciled$study_ID,
  cellDensity = reconciled$`4.1.3.4.1 Please specify the cell density cells/ml!_a995234c-c94e-4d14-8a6c-fe5bd759b928_Answer`)


cellDensity_num <- separate_rows(cellDensity_num, cellDensity, sep="\\|")
cellDensity_num <- separate_rows(cellDensity_num, cellDensity, sep=";")


# remove line breaks
cellDensity_num$cellDensity <- str_replace_all(cellDensity_num$cellDensity, "[\n]" , "")
cellDensity_num$cellDensity <- str_replace_all(cellDensity_num$cellDensity, "\\*10E" , "e+")

# remove whitespace from start of str
cellDensity_num$cellDensity <- str_trim(cellDensity_num$cellDensity, "left")

# remove whitespace from end of str
cellDensity_num$cellDensity <- str_trim(cellDensity_num$cellDensity, "right")


# rename answers to more easily group them
# cellDensity_num <- cellDensity_num %>% 
#       mutate(cellDensity = recode(cellDensity, "1*10E6" = "microarray spotter")) %>% mutate(cellDensity = recode(cellDensity, "scaffold free bioprinting" = "scaffold-free bioprinting"))


cellDensity_num$cellDensity <- as.numeric(cellDensity_num$cellDensity)

hist(cellDensity_num$cellDensity, breaks = 50)

# table(cellDensity_num$cellDensity)

```

### BioInk meta-data 
```{r}
# Frequency analysis of reported information for custom-formulated 4.1.3.2.3.

custom_bioInk <- tibble( 
   study_ID = reconciled$study_ID, 
   infoProivded =  reconciled$`4.1.3.2.3Â If custom formulated, which information is provided for the bioink?_fe62b3e4-d8f1-4584-a90d-e07317e4c8e1_Answer`
 # , comment = reconciled$`4.1.3.2.3Â If custom formulated, which information is provided for the bioink?_fe62b3e4-d8f1-4584-a90d-e07317e4c8e1_Comments`
 ) 


custom_bioInk <- separate_rows(custom_bioInk, infoProivded, sep="\\|")
custom_bioInk <- separate_rows(custom_bioInk, infoProivded, sep=";")

# group by numbers
custom_bioInk_count <- custom_bioInk %>%  group_by(infoProivded) %>% summarise(n_studies_report = length(unique(study_ID))) %>%  arrange(desc(n_studies_report))

library(formattable)

formattable(custom_bioInk_count,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_studies_report`= color_bar("lightblue")
))

custom_bioInk_studies <- custom_bioInk %>%  group_by(study_ID) %>% summarise(n_items_reported = length(unique(infoProivded))) %>%  arrange(desc(n_items_reported)) 

# hist(custom_bioInk_studies$n_items_reported)

t11 <- table(custom_bioInk_studies$n_items_reported)

barplot(table(custom_bioInk_studies$n_items_reported), ylab = "Number of studies", cex.names=.7, col = "lightblue")

text(x = barplot(t11, ylab = "Number of studies", ylim=c(0, max(t11) + 10), cex.names=.8 , col = "lightblue", main = "How many items were reported about custom-formulated bioink?"), y = t11 + 2, labels = t11, cex = 0.8)




```





### BioInk Sunburst plot
```{r bioink-sunburst}




#### BIOINK sunburst 

# type --> 
bioink <- reconciled %>%select(
  study_ID, 
    `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
    `4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`, 
    `4.1.3.1.4Â If Synthetic bioink: choose the type _e74ea0e0-a654-4ae2-b59e-2e0b14a4651a_Answer`, `4.1.3.1.2Â If Protein based: choose the type._621671b3-9f7e-4a22-80ac-14b02fdd0683_Answer`, 
`4.1.3.1.3 If Polysaccharides Based: choose the type. _fcea8bcb-da6c-4154-aa44-8ff4734fa4fe_Answer`
  )  


bioink <- bioink  %>% rename(typeGeneral_level1 = `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
   typeNatural_level2 = `4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`, 
  typeSynthetic_level2 = `4.1.3.1.4Â If Synthetic bioink: choose the type _e74ea0e0-a654-4ae2-b59e-2e0b14a4651a_Answer`, 
  typeProtein_level3 = `4.1.3.1.2Â If Protein based: choose the type._621671b3-9f7e-4a22-80ac-14b02fdd0683_Answer`, 
  typePoly_level3 = `4.1.3.1.3 If Polysaccharides Based: choose the type. _fcea8bcb-da6c-4154-aa44-8ff4734fa4fe_Answer`
)

bioink_split1 <- separate_rows(bioink, typeGeneral_level1 , sep="\\|")
bioink_split1_1 <- separate_rows(bioink_split1, typeNatural_level2 , sep="\\|")

bioink_split1_2 <- separate_rows(bioink_split1_1, typeProtein_level3 , sep="\\|")

bioink_split1_3 <- separate_rows(bioink_split1_2, typePoly_level3 , sep="\\|")

bioink_split2 <- separate_rows(bioink_split1_3, typeNatural_level2 , sep=";")
bioink_split3 <- separate_rows(bioink_split2, typeProtein_level3 , sep=";")
bioink_split3 <- separate_rows(bioink_split3, typePoly_level3 , sep=";")
# 148 rows
# 164 rows

test_bio <- bioink_split3 %>%
     mutate(typeNatural_level2 = replace(typeNatural_level2, typeGeneral_level1!="Natural", NA), 
            typeSynthetic_level2 = replace(typeSynthetic_level2, typeGeneral_level1!="Synthetic", NA), 
            typeProtein_level3 = replace(typeProtein_level3, typeNatural_level2!="Protein based", NA), 
            typePoly_level3 =  replace(typePoly_level3, typeNatural_level2!="Polysaccharide based", NA)
            )

test_bio$typeSynthetic_level2 <- as.character(test_bio$typeSynthetic_level2)
  

### merge level 2 & merge level 3 
test_bio$level3 <- ifelse(!is.na(test_bio$typeProtein_level3), test_bio$typeProtein_level3, test_bio$typePoly_level3)
test_bio$level2 <- ifelse(!is.na(test_bio$typeNatural_level2), test_bio$typeNatural_level2, test_bio$typeSynthetic_level2)

  

#### START PLOTTING

library(dplyr)
library(plotme)


bioInk_count <-  count(test_bio, 
                       typeGeneral_level1, 
                       level2,
                       level3
                       #,study_ID
                       )


# sunburst plot
count_to_sunburst(bioInk_count)

# fill by group size
count_to_sunburst(bioInk_count, fill_by_n = TRUE)

# treemap plot, ordered by group size
count_to_treemap(bioInk_count, sort_by_n = TRUE)

```



# Liver Cells
And then it is liver specific variables. 
- main type of liver cells 
- info about liver cells

AND - Main type of liver cells

if comments from reconciled - print out for all to see. 

if any of reviewer comments say HepG2 

```{r liver-cells}


table(reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`)
# clean? - Maren to clean 

      #                 Hepatoma cells                 Hepatoma cells;Other 
      #                             28                                    2 
      # Induced pluripotent stem cells Induced pluripotent stem cells;Other 
      #                              3                                    1 
      #                          Other                        Primary cells 
      #                             12                                   14 
      #   Primary cells;Hepatoma cells                  Primary cells;Other 
      #                              2                                    1 

### combine the ones with semi-colon - into a new category called "Combination"

liver_cells <- reconciled %>% 
  mutate(`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer` = recode(`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`, "Hepatoma cells;Other" = "Combination")) %>% 
   mutate(`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer` = recode(`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`, "Primary cells;Other" = "Combination")) 

t8 <- table(liver_cells$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`)

#barplot(table(reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`), ylab = "Number of studies", cex.names=.5, col = "turquoise")

text(x = barplot(t8, ylab = "Number of studies", ylim=c(0, max(t8) + 10), cex.names=.5 , col = "turquoise", main = "What type of Liver Cells are included"), y = t8 + 2, labels = t8, cex = 0.8, )


# ABB bring in the "other" from comments box 
###############################################################



# liver cells
#########################################

table(reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Comments`)

## clean the type of liver cells comments

liverType <- tibble(
  
  study_ID = reconciled$study_ID, 
  liverCells = reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`, 
  liverCellsComment = reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Comments`
  
)


# remove line breaks
library(stringr)
liverType$liverCellsComment <- str_replace_all(liverType$liverCellsComment, "[\n]" , "")
liverType <- separate_rows(liverType, liverCellsComment, sep=";")

# remove whitespace from start of str
liverType$liverCellsComment <- str_trim(liverType$liverCellsComment, "left")

# remove whitespace from end of str
liverType$liverCellsComment <- str_trim(liverType$liverCellsComment, "right")

liverType <- liverType %>% 
      mutate(liverCellsComment = recode(liverCellsComment, "Human iPSC-derived hepatocytes" = "human hepatocytes")) %>% 
      mutate(liverCellsComment = recode(liverCellsComment, "adult stem cell derived hepatocytes" = "human hepatocytes")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "cholangiocarinoma cells" = "human cells - other")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "bone marrow mesenchymal cells" = "human cells - other")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "hepatic progenitor cells" = "human cells - other")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "hepatic stellate cells" = "human cells - other")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "Hepatocellular carcinoma" = "human cells - other")) %>% 
    mutate(liverCellsComment = recode(liverCellsComment, "aHSC" = "human cells - other")) %>% 
    mutate(liverCellsComment = recode(liverCellsComment, "AML12" = "human cells - other")) %>% 
    mutate(liverCellsComment = recode(liverCellsComment, "hiHep" = "human cells - other")) %>% 
   mutate(liverCellsComment = recode(liverCellsComment, "hESC lines RC-6 and RC-10" = "human cells - other")) %>% 
  mutate(liverCellsComment = recode(liverCellsComment, "HMCS1SA" = "human cells - other")) %>% 
   mutate(liverCellsComment = recode(liverCellsComment, "liver biopsies" = "human liver tissue")) %>% 
   mutate(liverCellsComment = recode(liverCellsComment, "porcine liver tissue" = "porcine liver tissue"))

# liverType$liverCellsComment

## group the mouse ones together 
# 

# create categories
liverType$liverCellsComment <- as.factor(liverType$liverCellsComment)

commentsLiver <- liverType %>%  group_by(liverCellsComment) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(commentsLiver,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("turquoise")
))




#### how is LIVER model Cultered? 

table(reconciled$`2.2.1Â How is the presented liver model cultured?_b6e561ab-c358-47fa-b9db-61e363b73223_Answer`)
 # Co-culture Monoculture     Unclear 
 #         33          29           1 


barplot(table(reconciled$`2.2.1Â How is the presented liver model cultured?_b6e561ab-c358-47fa-b9db-61e363b73223_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")


# If co-culter - what type of non-parenchymal cells 
# - need to clean
table(reconciled$`2.2.1.1 If co-cultured, what type of non-parenchymal cells are included?_b729a62f-2dc7-47b6-ada7-e1ed8e363918_Answer`)
# Maren to clean manually - bring in "other" responses from comments box



# LIVER Model

table(reconciled$`3.1 Does the study present a vascularization of the model?_3b31a6ff-4233-4f24-9e7e-2d2eb3c83420_Answer`)
                    # No    Yes, with perfusion Yes, without perfusion 
                    # 52                      5                      6


barplot(table(reconciled$`3.1 Does the study present a vascularization of the model?_3b31a6ff-4233-4f24-9e7e-2d2eb3c83420_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")


## hypoxia 
table(reconciled$`3.2 Do the authors address hypoxia/normoxia/oxygenation of the liver model?_5b050ea7-da29-4a47-bdea-23edda5877f2_Answer`)
                 # No Yes, by measurement    Yes, descriptive 
                 # 59                   1                   3
barplot(table(reconciled$`3.2 Do the authors address hypoxia/normoxia/oxygenation of the liver model?_5b050ea7-da29-4a47-bdea-23edda5877f2_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")




```

# Liver Cell Meta-Data
```{r}
# Meta-data for Liver cells

table(reconciled$`2.4 Which kind of meta data is available for the used liver cells?_2868ee50-2c4c-47e8-a040-427e4f882632_Answer`)
## common cell line; None should get merged with Common Cell line option 
# re-shape data to can number of bits of info? 

liverCell_meta <- reconciled %>% mutate(`2.4 Which kind of meta data is available for the used liver cells?_2868ee50-2c4c-47e8-a040-427e4f882632_Answer` = recode(`2.4 Which kind of meta data is available for the used liver cells?_2868ee50-2c4c-47e8-a040-427e4f882632_Answer`, "Common cell line;None" = "Common cell line"))

liverMetaData <- separate_rows(liverCell_meta, `2.4 Which kind of meta data is available for the used liver cells?_2868ee50-2c4c-47e8-a040-427e4f882632_Answer` ,sep=";")


liverMetaData_heat <- liverMetaData[,c(1, 58)]

colnames(liverMetaData_heat) <- c("study_ID", "metaData")

countsMetaDat <- liverMetaData_heat %>% group_by(study_ID) %>% summarize(n_unique = length(unique(metaData)))

table(countsMetaDat$n_unique)
#  1  2  3 
# 56  2  5 


hist(countsMetaDat$n_unique, xlab = "Number of Meta-Data Items Reported", ylab = "Number of Papers", main = "Meta-Data Items about the Cell Lines Peformed per Paper", breaks = 3)

## convert to facotrs to display barplot
 countsMetaDat$n_unique <- as.factor(countsMetaDat$n_unique)


barplot(table(countsMetaDat$n_unique), ylab = "Number of studies", cex.names=.7, col = "turquoise")

```




# Cells 
What types of included cells? 
- human, animal, both
```{r cells}


table(reconciled$`2.1 What is the origin of the cells in the liver model?_d2a55b1d-f869-4fa4-83a1-94eeb126c6fb_Answer`)
#
# Animal   Both  Human 
#      4     14     45 

barplot(table(reconciled$`2.1 What is the origin of the cells in the liver model?_d2a55b1d-f869-4fa4-83a1-94eeb126c6fb_Answer`), ylab = "Number of studies", cex.names=.7, col = "pink")

```




## If human, is it Xeno-free? 
```{r}
table(reconciled$`2.1.1 If human, is the described liver model xeno-free/animal-free?_7b2396a2-218d-462b-b71f-0c68bc5e9911_Answer`)


barplot(table(reconciled$`2.1.1 If human, is the described liver model xeno-free/animal-free?_7b2396a2-218d-462b-b71f-0c68bc5e9911_Answer`)
, ylab = "Number of studies", cex.names=.7, col = "pink")
```



# Culture Conditions
What type of culture conditions? 
Liver Markers- what measurements? 
```{r culture-conditions}

table(reconciled$`5.2 How long were the liver models cultured after printing?_1f136f0a-786b-4e17-a97d-e5cf32f47b26_Answer`)
        # < 72 hours 2 weeks - 3 months   3 days - 2 weeks       not reported 
        #          2                 16                 42                  3 
barplot(table(reconciled$`5.2 How long were the liver models cultured after printing?_1f136f0a-786b-4e17-a97d-e5cf32f47b26_Answer`), ylab = "Number of studies", cex.names=.5, col = "purple")


## ABB to order these in time order 


```



# Liver Markers
```{r liver-marker}

# WHICH
t14 <- table(reconciled$`6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Answer`)
# clean? 


liverMarkers <- separate_rows(reconciled, `6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Answer` ,sep=";")

markers_heat <- liverMarkers[,c(1, 94)]

colnames(markers_heat) <- c("study_ID", "marker")

new_marker <- markers_heat %>% group_by(marker) %>% summarize(n_unique = length(unique(study_ID)))

new_marker$n_unique <- as.numeric(new_marker$n_unique)

sort_new_marker <- new_marker %>% arrange(desc(n_unique))



#install.packages("formattable")
library(formattable)

formattable(sort_new_marker,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("yellow")
))

######################
# liver marker "Other"

t <- table(reconciled$`6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Comments`)

## clean the type of liver cells comments


liverMarkerComments_rows <- separate_rows(reconciled, `6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Comments`
   ,sep=";")

liverMarkerComments <- tibble(
  study_ID = liverMarkerComments_rows$study_ID, 
  liverMarker = liverMarkerComments_rows$`6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Answer`, 
  liverMarkerComment = liverMarkerComments_rows$`6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Comments`
  
)

# remove line breaks
library(stringr)
liverMarkerComments$liverMarkerComment <- str_replace_all(liverMarkerComments$liverMarkerComment, "[\n]" , "")

liverMarkerComments_rows <- separate_rows(liverMarkerComments,liverMarkerComment
   ,sep=",")

liverMarkerComments_rows <- separate_rows(liverMarkerComments_rows,liverMarkerComment
   ,sep=" and")

# # would replace all white space
# liverMarkerComments$liverMarkerComment <- str_replace_all(liverMarkerComments$liverMarkerComment, "[^\d]+" , "")

# remove line breaks
liverMarkerComments_rows$liverMarkerComment <- str_replace_all(liverMarkerComments_rows$liverMarkerComment, "[\n]" , "")

# remove whitespace from start of str
liverMarkerComments_rows$liverMarkerComment <- str_trim(liverMarkerComments_rows$liverMarkerComment, "left")

# remove whitespace from end of str
liverMarkerComments_rows$liverMarkerComment <- str_trim(liverMarkerComments_rows$liverMarkerComment, "right")

liverMarkerComments_clean <- liverMarkerComments_rows %>%  
          mutate(liverMarkerComment = recode(liverMarkerComment,
                                       "albumin" = "Albumin", 
                                       "ALB" = "Albumin", 
                                       " ALB" = "Albumin",
                                       "	ALB" = "Albumin",
                                       "albumin ELISA" = "Albumin", 
                                       "Albumin " = "Albumin",
                                        "albumin (ALB)" = "Albumin", 
                                       "qPCR: albumin" = "Albumin",
                                       " Albumin" =  "Albumin",
                                       "human albumin" =  "Albumin",
                                       
                                       "urea" = "Urea", 
                                       "urea " = "Urea",
                                       " urea" = "Urea",
                                       " Urea" = "Urea",
                                       
                                       " transthyre- tin (TTR)" = "TTR", 
                                        " transthyretin (TTR)" = "TTR", 
                                       " transthyretin TTR" = "TTR", 
                                       " TTR" = "TTR", 
                                       "transthyretin TTR" = "TTR",
                                       "transthyretin (TTR)" = "TTR",
                                       "transthyre- tin (TTR)"  = "TTR",
                                       "transferrin" = "TTR",
                                       
                                      "HNF4a" = "HNF4alpha", 
                                     " HNF4a" = "HNF4alpha", 
                                     " HFN4alpha" = "HNF4alpha", 
                                     "	HNF4alpha" = "HNF4alpha", 
                                     "HFN4A" = "HNF4alpha",
                                     "s HNF4a" = "HNF4alpha",
                                     " HNF4alpha" = "HNF4alpha", 
                                     "  HFN4alpha" = "HNF4alpha", 
                                 "hepatocyte nuclear factor 4Î± (HNF4A)" = "HNF4alpha",
                                   "HFN4alpha"  = "HNF4alpha", 
                                     
                                     
                                     " AFP" = "AFP",
                                     " alpha-fetoprotein (AFP)" = "AFP", 
                                     " alpha-fetoprotein" = "AFP", 
                                     "alpha-fetoprotein levels (HCC marker)" = "AFP", 
                                     " Î±-fetoprotein (AFP)" = "AFP", 
                                     "alpha-fetoprotein" = "AFP", 
                                     "Alpha-fetoprotein AFP" = "AFP", 
                                     "alpha-fetoprotein (AFP)" = "AFP",
                                     "Î±-fetoprotein (AFP)" = "AFP",
                                     
                                     
                                     " cytokeratin 19 (CK19)" = "cytokeratin 19 (CK19)", 
                                     " cytokeratin 19" = "cytokeratin 19 (CK19)",
                                     " CK-19" = "cytokeratin 19 (CK19)",
                                     "CK-19" = "cytokeratin 19 (CK19)",
                                     "cytokeratin 19"  = "cytokeratin 19 (CK19)",
                                     
                                     
                                 "CK18" = "cytokeratin 18 (CK18)", 
                                 
                              
                                     "staning for MRP2" = "MRP2", 
                                     " MRP2" = "MRP2",
                        "multidrug resist- ance-associated protein 2 (MRP2)" = "MRP2",
                                     
                                     
                                     "CYP4A4 activity" = "CYP3A4", 
                                      "	CYP3A4" = "CYP3A4",              
                                     " CYP3A4" = "CYP3A4", 
                                     "Cyp3A4"= "CYP3A4", 
                                 "cytochrome P450 3A4 (CYP3A4)" = "CYP3A4",
                                 
                                 "Cytochromes 1A2" = "CYP1A2", 
                                 
                                
                                 "alpha-1 antitrypsin (A1AT)" = "alpha-1 antitrypsin", 
                                 "alpha-1 antitrypsin (AAT)" = "alpha-1 antitrypsin", 
                                 "Alpha 1 antitrypsin" = "alpha-1 antitrypsin"
                                                     )) 

commentsLiver <- liverMarkerComments_clean %>%  group_by(liverMarkerComment) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))

commentsLiver

#install.packages("formattable")
library(formattable)

formattable(commentsLiver,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("yellow")
))


## trying 6.4 
# which metabolites were analysed 
t <- table(reconciled$`6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Answer`)

liverMetabolite <- separate_rows(reconciled, `6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Answer`
   ,sep=";")

liverMetabolite$`6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Comments` <- str_replace_all(liverMetabolite$`6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Comments`, "[\n]" , "")

liverMetabolite_comments <-  liverMetabolite %>% select(c(study_ID, `6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Answer`, `6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Comments`))


commentsLiverMetabolite <- liverMetabolite_comments %>%  group_by(`6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Answer`) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))


otherLiverMetabolite <- liverMetabolite_comments %>%  group_by(`6.4 Which metabolites were analyzed in the study?_5652d702-1441-4234-b37d-f0b44d64c5e9_Comments`) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))

# print(otherLiverMetabolite)

#install.packages("formattable")
library(formattable)

formattable(commentsLiverMetabolite,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("yellow")
))


#### CLEAN THIS!! 
formattable(otherLiverMetabolite, 
             align = c("l", "r"), 
             list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("yellow")
            
            ))



#####################


# WHERE
table(reconciled$`6.1.1 Where were the liver markers measured?_a70225ae-f529-4b91-bcc9-8081d7efc6e2_Answer`)
       # Cells        Media  Media;Cells Not reported 
       #    10           15           19           19 
barplot(table(reconciled$`6.1.1 Where were the liver markers measured?_a70225ae-f529-4b91-bcc9-8081d7efc6e2_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")


# CYP450 
table(reconciled$`6.2 Does the study analyse the Cytochrome P450 CYP450 level in the print?_3c21cc1f-1431-49c7-ad8f-bda83956828a_Answer`)
 # No Yes 
 # 33  30 

barplot(table(reconciled$`6.2 Does the study analyse the Cytochrome P450 CYP450 level in the print?_3c21cc1f-1431-49c7-ad8f-bda83956828a_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")

table(reconciled$`6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Answer`)
## output needs cleaning

liverCytochome <- separate_rows(reconciled, `6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Answer`
   ,sep=";")

liverCytochome_only <-  liverCytochome %>% select(c(study_ID, `6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Answer`, `6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Comments`))


liverCytochome_only <- liverCytochome_only %>%  group_by(`6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Answer`) %>% summarise(n_unique = length(unique(study_ID))) %>%  arrange(desc(n_unique))

formattable(liverCytochome_only,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("yellow")
))


## agonists
table(reconciled$`6.3 Have agonists of the receptors for the inducibility of CYPs been applied?_ac9f38a8-8fe2-44de-a180-24fddd78fb59_Answer`)
 # No Yes 
 # 54   9 
barplot(table(reconciled$`6.3 Have agonists of the receptors for the inducibility of CYPs been applied?_ac9f38a8-8fe2-44de-a180-24fddd78fb59_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")


```



# Quality
- Quality Assays
- storage conditions
- application
- time

## Does the study describe quality assurance? 
```{r quality}


table(reconciled$`5.3 Does the study describe quality-assuring assays for the printed model?_09745b80-9723-4e5c-8a47-dfc8a9c71a6d_Answer`)
# Yes 
#  63

```


## Which assays were performed? 
```{r quality-assays}
library(tidyverse)
### messy - needs cleaning
messy_assay <- table(reconciled$`5.3.1 Which assays were performed to assure the quality of the liver model?_8a415412-28c6-48ff-840a-538ea69a068f_Answer`)
# needs cleaning 


assays <- separate_rows(reconciled, `5.3.1 Which assays were performed to assure the quality of the liver model?_8a415412-28c6-48ff-840a-538ea69a068f_Answer` ,sep=";")

assays_heat <- assays[,c(1, 91)]

colnames(assays_heat) <- c("study_ID", "assay")

new <- assays_heat %>% group_by(assay) %>% summarize(n_unique = length(unique(study_ID)))

new$n_unique <- as.numeric(new$n_unique)

sort_new <- new %>% arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(sort_new,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("lightgreen")
))

### 10 different tests are used across 63 papers, a total of 252 tests were used. 
# the most popular are listed below








## also how many assay were performed? 1, 2, 3, 4, 5, or more. 


counts <- assays_heat %>% group_by(study_ID) %>% summarize(n_unique = length(unique(assay)))

table(counts$n_unique)
 # 1  2  3  4  5  6  7 
 # 4 10  6 17 16  8  2

hist(counts$n_unique, xlab = "Number of Assays Reported", ylab = "Number of Papers", main = "Number of Assays Peformed per Paper",)





```


## Applications in the paper
```{r}
# Application 
table(reconciled$`7.1 Do the authors apply the model in the study?_a6895d38-a9ed-4605-a092-4f06ebbd9e2b_Answer`)
 # No Yes 
 # 35  28 

barplot(table(reconciled$`7.1 Do the authors apply the model in the study?_a6895d38-a9ed-4605-a092-4f06ebbd9e2b_Answer`), ylab = "Number of studies", cex.names=.7, col = "gray")

# field of application 
table(reconciled$`7.1.1 please select the field of application. _d332c2ee-9864-434f-8595-90305808e32d_Answer`)

```


```{r sankey}

# import numpy as np
# import pandas as pd
# 
# import plotly.graph_objects as go
# import plotly.express as px
# import plotly.colors
# from plotly.subplots import make_subplots
# 
# from rpy2.robjects.packages import importr
# import rpy2.robjects

library(plotly)

screening_info <- c('Records obtained from the Medline database',
                  'Records obtained from previous reviews',
                  "",
                    "Exclusion critera:<br>
                    - work relying only on MRI;<br>
                    - work relying only on histology or equivalent approach;<br>
                    - work reporting only qualitative comparisons.",
                  "",
                  'Records selected for full-text evaluation',
                  "",
                    "Exclusion criteria:<br>
                    - studies using MRI-based measures in arbitrary units;<br>
                    - studies using measures of variation in myelin content;<br>
                    - studies using arbitrary assessment scales;<br>
                    - studies comparing absolute measures of myelin with relative measures;<br>
                    - studies reporting other quantitative measures than correlation or R^2 values;<br>
                    - studies comparing histology from one dataset and MRI from a different one.",
                  "",
                  'Studies selected for literature overview',
                  "",
                    "Exclusion criteria:<br>
                     - not providing an indication of both number of subjects and number of ROIs.",
                  "")


fig1 <- plot_ly(
  type = "sankey", 
  orientation = "h", 
 # arrangement = "freeform", 
  node = list(
    label = c("Main records identified (database searching)",
             "Additional records (reviews)",
             "Records screened",
             "Records excluded",
             "Full-text articles assessed for eligibility",
             "Full-text articles excluded",
             "Studied included in the literature overview",
             "Studies included in the meta-analysis"), 
    Color = c("darkblue","darkblue","darkblue","darkred","darkgreen","darkred","darkgreen","darkgreen"), 
    pad = 15, 
    thickness = 20, 
    line = list(
     color =  "black", 
     width = 0.5
    ), 
   domain = 
     list(x = c(0, 0, 0.4, 0.6, 0.5, 0.8, 0.7, 1),
    y = c(0, 0, 0.5, 0.8, 0.15, 0.05, 0.4, 0.6)),
    
    link = list(
    source = c(0, 1, 2, 2, 4, 4, 6),
    target = c(2, 2, 3, 4, 5, 6, 7),
    value = c(688, 1, 597, 92, 34, 58, 43)
  #  ,customdata = screening_info,
  #  hovertemplate = "%{customdata}"
  ), 
  
  width=950,
height=500 
 #    x=1.02, y=-0.21,
 # sizex=0.05, sizey=0.05,
# xanchor="right", yanchor="bottom"
)
) 



fig1 <- fig1 %>% layout(
    title = "Screening Sankey Diagram",
    
    font = list(
      size = 12
    )
)

fig1

###########################################################


#### prep data for sankey diagram
# type --> 
Print_bioink <- reconciled %>%select(
  study_ID, 
  `4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`,
  `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
  `4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`, 
  `4.1.3.1.4Â If Synthetic bioink: choose the type _e74ea0e0-a654-4ae2-b59e-2e0b14a4651a_Answer`, 
  `4.1.3.1.2Â If Protein based: choose the type._621671b3-9f7e-4a22-80ac-14b02fdd0683_Answer`, 
  `4.1.3.1.3 If Polysaccharides Based: choose the type. _fcea8bcb-da6c-4154-aa44-8ff4734fa4fe_Answer`
)  


Print_bioink <- Print_bioink  %>% rename(
  print_method = `4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`,
  typeGeneral_level1 = `4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`, 
  typeNatural_level2 = `4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`, 
  typeSynthetic_level2 = `4.1.3.1.4Â If Synthetic bioink: choose the type _e74ea0e0-a654-4ae2-b59e-2e0b14a4651a_Answer`, 
  typeProtein_level3 = `4.1.3.1.2Â If Protein based: choose the type._621671b3-9f7e-4a22-80ac-14b02fdd0683_Answer`, 
  typePoly_level3 = `4.1.3.1.3 If Polysaccharides Based: choose the type. _fcea8bcb-da6c-4154-aa44-8ff4734fa4fe_Answer`
)



Print_bioink1 <- Print_bioink %>% 
                separate_rows(print_method , sep="\\|") %>% 
              separate_rows(typeGeneral_level1, sep="\\|") 

Print_bioink1$print_method <- as.factor(Print_bioink1$print_method)
Print_bioink1$typeGeneral_level1 <- as.factor(Print_bioink1$typeGeneral_level1 )
  
summary(Print_bioink1)

Print_bioink1_sankey <- Print_bioink1 %>% select(study_ID, print_method, typeGeneral_level1)


# create a table of frequencies
freq_table <- Print_bioink1_sankey %>% group_by(print_method, typeGeneral_level1) %>% 
  summarise(n = n())


# create a nodes data frame
nodes <- data.frame(name = unique(c(as.character(freq_table$print_method),
                                    as.character(freq_table$typeGeneral_level1))))


# create links dataframe
links <- data.frame(source = match(freq_table$print_method, nodes$name) - 1,
                    target = match(freq_table$typeGeneral_level1, nodes$name) - 1,
                    value = freq_table$n,
                    stringsAsFactors = FALSE)







###############################


# Make Sankey diagram
plot_ly(
  type = "sankey",
  orientation = "h",
  node = list(pad = 15,
              thickness = 20,
              line = list(color = "black", width = 0.5),
              label = nodes$name),
  link = list(source = links$source,
              target = links$target,
              value = links$value),
  textfont = list(size = 10),
  width = 720,
  height = 480
) %>%
  layout(title = "Sankey Diagram: Print Method & Ink Type",
         font = list(size = 14),
         margin = list(t = 40, l = 10, r = 10, b = 10))



###############################
## test code that works


fig <- plot_ly(
    type = "sankey",
    orientation = "h",
    node = list(
       label = c("Main records identified (database searching)",
             "Additional records (reviews)",
             "Records screened",
             "Records excluded",
             "Full-text articles assessed for eligibility",
             "Full-text articles excluded",
             "Studied included in the literature overview",
             "Studies included in the meta-analysis"), 
      Color = c("darkblue","darkblue","darkblue","darkred","darkgreen","darkred","darkgreen","darkgreen"), 
      pad = 15,
      thickness = 20,
      line = list(
        color = "black",
        width = 0.5
      )
    ),

     link = list(
    source = c(0, 1, 2, 2, 4, 4, 6),
    target = c(2, 2, 3, 4, 5, 6, 7),
    value = c(688, 1, 597, 92, 34, 58, 43)
    )
  )


fig <- fig %>% layout(
    title = "Basic Sankey Diagram",
    font = list(
      size = 10
    )
)

fig


```



