---
title: "Analysis"
author: "ABB"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)

# green is the reconciled one
# (NOT to be answered by REVIEWER) Has the study been reconciled?_cb623db2-5f5e-4676-9497-f22d4d58fd02 == YES is reconciled

#read in document
library(openxlsx)
data <- openxlsx::read.xlsx("0531_final_data_after_cleaning.xlsx", fillMergedCells = TRUE, colNames = FALSE)

names(data) <- paste(data[1, ], data[2, ], sep = "_")
names(data)[1] <- "study_ID"
# Get rid of first two rows and columns 
data <- data[-c(1:2), ]

# clean column names
library(janitor)

clean_names(data)
# remove brackets so can search by numbers
colnames(data) <-  gsub("\\(|)","",colnames(data))


library(tidyverse)
## get only reconciled
reconciled <- data %>% subset(data$`NOT to be answered by REVIEWER Has the study been reconciled?_cb623db2-5f5e-4676-9497-f22d4d58fd02_Answer` == "Yes") 

# check the number of reconciled studies and confirm with project lead 
nrow(reconciled)
# 63

length(unique(reconciled$study_ID))
# 63 unique studies

# make all columns factors
cols <- colnames(reconciled[,21:170])
reconciled[cols] <- lapply(reconciled[cols], factor)

```

## Plan of analysis to be carried out

<!-- https://lucid.app/lucidchart/07544fa2-2781-40f0-b03b-d3d3595d9443/edit?viewport_loc=-325%2C-1822%2C3711%2C2979%2C0_0&invitationId=inv_b89952a6-b78e-49f7-9d45-e64aa7af5638  -->

for simple diagrams, 

for complex connections - sankey diagram - for the link between printing methods + printing model with a link to the bioink type (+ origin)?

first things first, to give numbers of studies that report e.g. A or B

# Printing Techniques 

Give an overview of the different printing techniques, 
- method
- printer model
- printer source
- forms 
- software 


## Kind of Printer Method
```{r printing-method, echo = TRUE}
table(reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`)
##
        # Extrusion based Extrusion based|Unclear            Inject based 
        #              37                       1                       4 
        #           Other       Stereolithography                 Unclear 
        #               9                       2                      10

# proportions instead of absolute value of number of studies 
prop.table(table(reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`))

barplot(table(reconciled$`4.1 What kind of printing method is used?_ae684e28-4f90-44ad-9de2-731d076de0b0_Answer`), ylab = "Number of studies", cex.names=.5 , col = "green")


```


## Reporting of Printer Model 
```{r printer-model}

#### Reporting of Printer Model

table(reconciled$`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`)
         # Not reported Not reported|Reported              Reported 
         #           22                     1                    4

both_print <- reconciled %>% subset(`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer` == "Not reported|Reported")

barplot(table(reconciled$`4.1.1 Do the authors report the printer model name/number?_a3e72486-56d3-4154-a45f-9fb87b8612fc_Answer`), ylab = "Number of studies")

```


## Printer Source 
```{r printer-source}

#### Reporting of Printer Source

table(reconciled$`4.1.2 What is the source of the printer?_102ba965-5234-4b3e-8b23-bd70cf4e074d_Answer`)
         # commercial modified commercial        not reported 
         #         36                   4                   4 
         #  self-made             unclear  unclear|commercial 
         #         13                   5                   1

barplot(table(reconciled$`4.1.2 What is the source of the printer?_102ba965-5234-4b3e-8b23-bd70cf4e074d_Answer`), ylab = "Number of studies", cex.names=.5,  col = "green")

```


## Printer Forms 
```{r printer-forms}

#### Reporting of Printer forms
# split is based on the ink

table(reconciled$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`)
# clean response
# combo ; 
# pipe should be merged 


        #                Grid                  Grid;Other 
        #                  19                           1 
        #           Grid|Grid               lobular liver 
        #                   2                           7 
        # lobular liver;Other lobular liver|lobular liver 
        #                   1                           2 
        #               Other                 Other|Other 
        #                  25                           5 
        #             Toroids 
        #                   1

barplot(table(reconciled$`4.1.4 What kind of forms are printed with this ink?_01d3ca37-1e2f-4087-8f39-c183f98f0c4e_Answer`), ylab = "Number of studies", cex.names=.5 , col = "green")

```


## Printer Software 
```{r printer-software}

#### Reporting of Printer software

table(reconciled$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`)
            # No          No|No Not applicable            Yes 
            # 39              1              1             22

barplot(table(reconciled$`4.1.5 Do the authors report the name of the 3D modelling software?_f88d82a9-410c-4118-ad6a-4535d12c4aca_Answer`), ylab = "Number of studies", cex.names=.5, col = "green")

## Slicing Software

# - since the review started, many cases - not applicable 
# merge NA with No and merge No|No with NO
table(reconciled$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`)
            # No          No|No Not applicable            Yes 
            # 53              1              1              8 
barplot(table(reconciled$`4.1.6 Do the authors report the name of slicing software?_bc07fc45-10aa-441f-9bdf-b32f5037389f_Answer`), ylab = "Number of studies", cex.names=.5, col = "green")

```



# BioInks

Give an overview of the different inks used with these techniques. 
- type
- origin
- additives
- density

```{r printing-inks, echo=TRUE}
## Type of BioInk
table(reconciled$`4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`)
# clean? 

        #      Natural      Natural|Natural    Natural|Synthetic 
        #           43                    3                    5 
        # Not reported Not reported|Natural            Synthetic 
        #            2                    1                    4 
        #      Unclear 
        #            5 

barplot(table(reconciled$`4.1.3 What type of bioink was used?_92421414-c597-4e9c-b720-9bb4318b5483_Answer`), ylab = "Number of studies", cex.names=.5, col = "blue")

## If natural - type
table(reconciled$`4.1.3.1.1 If natural bioink, please choose the type._66b761ad-6630-4323-b423-c848a717aae4_Answer`)
# output needs cleaning 



## Origin of BioInk 
table(reconciled$`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`)
# needs cleaning

#           commercial (ready-to-use)                   custom formulated 
#                                   6                                  44 
# custom formulated|custom formulated                        Not reported 
#                                   8                                   2 
#                             Unclear                     Unclear|Unclear 
#                                   2                                   1 

barplot(table(reconciled$`4.1.3.2.Â What is the origin of the bioink?_34ef46b6-34ac-4ddb-a5de-07bc74272fca_Answer`), ylab = "Number of studies", cex.names=.5, col = "blue")


### Additives
# -- needs cleaning 
table(reconciled$`4.1.3.3Â Which information is provided on the additives in the ink or culture?Â _4c2b5908-9c3c-4ba8-91f2-dd9771ac2ad4_Answer`)
# needs cleaning



## Cell density of bioInk
table(reconciled$`4.1.3.4 Is the cell density of the bioinkÂ provided in the study?Â _d03a497a-c8ab-49a6-8fa7-5eca0d168c94_Answer`)
# needs cleaning 

     # No   No|No  No|Yes     Yes  Yes|No Yes|Yes 
     # 11       1       1      43       1       6 


```




# Liver Cells
And then it is liver specific variables. 
- main type of liver cells 
- info about liver cells

AND - Main type of liver cells

if comments from reconciled - print out for all to see. 

if any of reviewer comments say HepG2 

```{r liver-cells}


table(reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`)
# clean? 



barplot(table(reconciled$`2.2Â What is the main type of liver cells included?_9bea404f-a75c-401f-af5b-8fd020306538_Answer`), ylab = "Number of studies", cex.names=.5, col = "turquoise")


table(reconciled$`2.2.1Â How is the presented liver model cultured?_b6e561ab-c358-47fa-b9db-61e363b73223_Answer`)
 # Co-culture Monoculture     Unclear 
 #         33          29           1 


barplot(table(reconciled$`2.2.1Â How is the presented liver model cultured?_b6e561ab-c358-47fa-b9db-61e363b73223_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")


# If co-culter - what type of non-parenchymal cells 
# - need to clean
table(reconciled$`2.2.1.1 If co-cultured, what type of non-parenchymal cells are included?_b729a62f-2dc7-47b6-ada7-e1ed8e363918_Answer`)



# Meta-data for Liver cells

table(reconciled$`2.4 Which kind of meta data is available for the used liver cells?_2868ee50-2c4c-47e8-a040-427e4f882632_Answer`)
## common cell line; None should get merged with Common Cell line option 
# re-shape data to can number of bits of info? 



# LIVER Model

table(reconciled$`3.1 Does the study present a vascularization of the model?_3b31a6ff-4233-4f24-9e7e-2d2eb3c83420_Answer`)
                    # No    Yes, with perfusion Yes, without perfusion 
                    # 52                      5                      6


barplot(table(reconciled$`3.1 Does the study present a vascularization of the model?_3b31a6ff-4233-4f24-9e7e-2d2eb3c83420_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")


## hypoxia 
table(reconciled$`3.2 Do the authors address hypoxia/normoxia/oxygenation of the liver model?_5b050ea7-da29-4a47-bdea-23edda5877f2_Answer`)
                 # No Yes, by measurement    Yes, descriptive 
                 # 59                   1                   3
barplot(table(reconciled$`3.2 Do the authors address hypoxia/normoxia/oxygenation of the liver model?_5b050ea7-da29-4a47-bdea-23edda5877f2_Answer`), ylab = "Number of studies", cex.names=.7, col = "turquoise")




```


# Cells 
What types of included cells? 
- human, animal, both
```{r cells}


table(reconciled$`2.1 What is the origin of the cells in the liver model?_d2a55b1d-f869-4fa4-83a1-94eeb126c6fb_Answer`)
#
# Animal   Both  Human 
#      4     14     45 

barplot(table(reconciled$`2.1 What is the origin of the cells in the liver model?_d2a55b1d-f869-4fa4-83a1-94eeb126c6fb_Answer`), ylab = "Number of studies", cex.names=.7, col = "pink")

```




## If human, is it Xeno-free? 
```{r}
table(reconciled$`2.1.1 If human, is the described liver model xeno-free/animal-free?_7b2396a2-218d-462b-b71f-0c68bc5e9911_Answer`)


barplot(table(reconciled$`2.1.1 If human, is the described liver model xeno-free/animal-free?_7b2396a2-218d-462b-b71f-0c68bc5e9911_Answer`)
, ylab = "Number of studies", cex.names=.7, col = "pink")
```



# Culture Conditions
What type of culture conditions? 
Liver Markers- what measurements? 
```{r culture-conditions}

table(reconciled$`5.2 How long were the liver models cultured after printing?_1f136f0a-786b-4e17-a97d-e5cf32f47b26_Answer`)
        # < 72 hours 2 weeks - 3 months   3 days - 2 weeks       not reported 
        #          2                 16                 42                  3 
barplot(table(reconciled$`5.2 How long were the liver models cultured after printing?_1f136f0a-786b-4e17-a97d-e5cf32f47b26_Answer`), ylab = "Number of studies", cex.names=.5, col = "purple")





```



# Liver Markers
```{r liver-marker}

# WHICH
table(reconciled$`6.1 Which liver markers were analysed in the presented model?_1844378b-1400-4d7a-b9f5-5538df7c7b76_Answer`)
# clean? 


# WHERE
table(reconciled$`6.1.1 Where were the liver markers measured?_a70225ae-f529-4b91-bcc9-8081d7efc6e2_Answer`)
       # Cells        Media  Media;Cells Not reported 
       #    10           15           19           19 
barplot(table(reconciled$`6.1.1 Where were the liver markers measured?_a70225ae-f529-4b91-bcc9-8081d7efc6e2_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")


# CYP450 
table(reconciled$`6.2 Does the study analyse the Cytochrome P450 CYP450 level in the print?_3c21cc1f-1431-49c7-ad8f-bda83956828a_Answer`)
 # No Yes 
 # 33  30 

barplot(table(reconciled$`6.2 Does the study analyse the Cytochrome P450 CYP450 level in the print?_3c21cc1f-1431-49c7-ad8f-bda83956828a_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")

table(reconciled$`6.2.1 If yes, which cytochrome isoforms were analysed?_62bdffd7-d9c7-4646-9f66-9510f5bf2649_Answer`)
## output needs cleaning


## agonists
table(reconciled$`6.3 Have agonists of the receptors for the inducibility of CYPs been applied?_ac9f38a8-8fe2-44de-a180-24fddd78fb59_Answer`)
 # No Yes 
 # 54   9 
barplot(table(reconciled$`6.3 Have agonists of the receptors for the inducibility of CYPs been applied?_ac9f38a8-8fe2-44de-a180-24fddd78fb59_Answer`), ylab = "Number of studies", cex.names=.7, col = "yellow")


```



# Quality
- Quality Assays
- storage conditions
- application
- time

## Does the study describe quality assurance? 
```{r quality}


table(reconciled$`5.3 Does the study describe quality-assuring assays for the printed model?_09745b80-9723-4e5c-8a47-dfc8a9c71a6d_Answer`)
# Yes 
#  63

```


## Which assays were performed? 
```{r quality-assays}
library(tidyverse)
### messy - needs cleaning
table(reconciled$`5.3.1 Which assays were performed to assure the quality of the liver model?_8a415412-28c6-48ff-840a-538ea69a068f_Answer`)
# needs cleaning 


assays <- separate_rows(reconciled, `5.3.1 Which assays were performed to assure the quality of the liver model?_8a415412-28c6-48ff-840a-538ea69a068f_Answer` ,sep=";")


assays_heat <- assays[,c(1, 91)]

colnames(assays_heat) <- c("study_ID", "assay")


new <- assays_heat %>% group_by(assay) %>% summarize(n_unique = length(unique(study_ID)))

new$n_unique <- as.numeric(new$n_unique)

sort_new <- new %>% arrange(desc(n_unique))


#install.packages("formattable")
library(formattable)

formattable(sort_new,
            align =c("l", "r"),
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")), 
              `n_unique`= color_bar("lightgreen")
))

### 10 different tests are used across 63 papers, a total of 252 tests were used. 
# the most popular are listed below



## heat map of which assay were performed - will be more than 63 




## also how many assay were performed? 1, 2, 3, 4, 5, or more. 
# sum <- assays_heat %>%
#   group_by(study_ID) %>%
#   summarise_each(
#     funs(n_distinct))


counts <- assays_heat %>% group_by(study_ID) %>% summarize(n_unique = length(unique(assay)))

table(counts$n_unique)
 # 1  2  3  4  5  6  7 
 # 4 10  6 17 16  8  2

hist(counts$n_unique, xlab = "Number of Assays Reported", ylab = "Number of Papers", main = "Number of Assays Peformed per Paper",)





```


## Applications in the paper
```{r}
# Application 
table(reconciled$`7.1 Do the authors apply the model in the study?_a6895d38-a9ed-4605-a092-4f06ebbd9e2b_Answer`)
 # No Yes 
 # 35  28 

barplot(table(reconciled$`7.1 Do the authors apply the model in the study?_a6895d38-a9ed-4605-a092-4f06ebbd9e2b_Answer`), ylab = "Number of studies", cex.names=.7, col = "gray")

# field of application 
table(reconciled$`7.1.1 please select the field of application. _d332c2ee-9864-434f-8595-90305808e32d_Answer`)

```

